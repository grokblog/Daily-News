name: Set & Forget Daily Blog (Cloud)

on:
  schedule:
    - cron: '30 22 * * *'  # Jalan jam 5:30 pagi WIB (22:30 UTC)
  workflow_dispatch:      # Bisa diklik manual di tab Actions

jobs:
  automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸš€ Setup Cloud Config
      env:
        SETTING_TOML: ${{ secrets.SETTING_TOML }} 
      run: |
        mkdir -p data
        echo "$SETTING_TOML" > data/setting.toml
        echo "âœ… Gateway Configured"

    - name: ğŸŒ Start Grok Gateway
      run: |
        # Jalankan main.py di background
        nohup python main.py > gateway.log 2>&1 &
        echo "â³ Menunggu Gateway Login (30 detik)..."
        
        # Loop untuk cek apakah gateway sudah ready
        for i in {1..10}; do
          if curl -s http://localhost:8017/health; then
            echo "âœ… Gateway READY!"
            break
          fi
          echo "Dormant... mencoba lagi dalam 3 detik ($i/10)"
          sleep 3
        done
        
        # Tampilkan logs sedikit untuk tracking
        tail -n 20 gateway.log

    - name: ğŸ“ Auto-Generate Content
      env:
        USE_LOCAL_GATEWAY: "true"
        GROK_API_URL: "http://localhost:8017/v1/chat/completions"
      run: |
        # Generate 3 artikel baru
        python blog_generator.py --count 3 || (cat gateway.log && exit 1)
        
    - name: ğŸ—ï¸ Build Site
      run: |
        python build_site.py

    - name: ğŸ“¤ Push New Content
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/
        git commit -m "Set & Forget: Auto Update $(date)" || echo "No changes"
        git push
