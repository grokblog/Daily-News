name: Set & Forget Daily Blog (Cloud)

on:
  schedule:
    - cron: '30 22 * * *'  # 05:30 WIB
  workflow_dispatch:      # Manual trigger

jobs:
  automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Pastikan semua library terinstall
        pip install -r requirements.txt
        pip install sqlmodel pydantic-settings httpx  # Library tambahan yang mungkin dibutuhkan app/

    - name: ğŸš€ Setup Cloud Config
      env:
        SETTING_TOML: ${{ secrets.SETTING_TOML }} 
      run: |
        mkdir -p data
        if [ -n "$SETTING_TOML" ]; then
          echo "$SETTING_TOML" > data/setting.toml
          echo "âœ… Gateway Configured with Cookies"
        else
          echo "âŒ ERROR: SETTING_TOML secret is EMPTY! Please check GitHub Secrets."
          exit 1
        fi

    - name: ğŸŒ Start Grok Gateway
      run: |
        # Jalankan gateway di background dan simpan logs
        # Gunakan port 8017 seperti di blog_config.py
        nohup python main.py > gateway.log 2>&1 &
        
        echo "â³ Menunggu Gateway inisialisasi (45 detik)..."
        # Health check loop
        for i in {1..15}; do
          echo "Check Gateway status... ($i/15)"
          if curl -s http://localhost:8017/health; then
            echo "âœ… Gateway READY!"
            break
          fi
          # Jika loop terakhir masih gagal, tampilkan logs
          if [ $i -eq 15 ]; then
             echo "âŒ Gateway FAIL - Menampilkan 50 baris log terakhir:"
             tail -n 50 gateway.log
             exit 1
          fi
          sleep 3
        done

    - name: ğŸ“ Auto-Generate Content
      env:
        USE_LOCAL_GATEWAY: "true"
        GROK_API_URL: "http://localhost:8017/v1/chat/completions"
      run: |
        # Coba generate artikel. Jika gagal 0 artikel, tampilkan log gateway.
        python blog_generator.py --count 3 || (tail -n 100 gateway.log && exit 1)
        
    - name: ğŸ—ï¸ Build Site
      run: |
        python build_site.py

    - name: ğŸ“¤ Push New Content
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/
        git commit -m "Set & Forget: Auto Update $(date)" || echo "No changes"
        git push
